{% extends 'blog/base.html' %}
{% load i18n widget_tweaks %}

{% block title %}{% if edit_mode %}{% trans "Edit Post" %}{% else %}{% trans "New Post" %}{% endif %} - {{ turma.name }}{% endblock %}

{% block blog_content %}
<main role="main" aria-label="{% if edit_mode %}{% trans 'Edit post form' %}{% else %}{% trans 'New post form' %}{% endif %}">
  <div class="row g-4 align-items-start">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="card-title h4 mb-3">{% if edit_mode %}{% trans "Edit Post" %}{% else %}{% trans "New Post" %}{% endif %}</h2>
          {% if request.user.is_authenticated %}
            <div class="mb-3">
              {% include "ai/assistant_button.html" with origin_app="blog" class_id=turma.id|default_if_none:'' context_descriptor=form.instance.titulo|default:_('Blog da turma') prefill=_('Sugere perguntas ou formas de envolver a turma neste registo.') %}
            </div>
          {% endif %}
          <form method="post" enctype="multipart/form-data" aria-label="{% trans 'Post submission form' %}">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger" role="alert">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            {% if not turma %}
              <div class="mb-3">
                <label for="{{ form.turma.id_for_label }}" class="form-label">{{ form.turma.label }}</label>
                {% render_field form.turma class+="form-select" %}
                {% if form.turma.help_text %}<div class="form-text">{{ form.turma.help_text }}</div>{% endif %}
                {% if form.turma.errors %}<div class="invalid-feedback d-block">{{ form.turma.errors }}</div>{% endif %}
              </div>
            {% endif %}

            <div class="mb-3">
              <label for="{{ form.titulo.id_for_label }}" class="form-label">{{ form.titulo.label }}</label>
              {% render_field form.titulo class+="form-control" placeholder=form.titulo.help_text %}
              {% if form.titulo.errors %}<div class="invalid-feedback d-block">{{ form.titulo.errors }}</div>{% endif %}
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="{{ form.categoria.id_for_label }}" class="form-label">{{ form.categoria.label }}</label>
                {% render_field form.categoria class+="form-select" %}
                {% if form.categoria.help_text %}<div class="form-text">{{ form.categoria.help_text }}</div>{% endif %}
                {% if form.categoria.errors %}<div class="invalid-feedback d-block">{{ form.categoria.errors }}</div>{% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label for="{{ form.conteudo.id_for_label }}" class="form-label">{{ form.conteudo.label }}</label>
              {{ form.conteudo }}
              {% if form.conteudo.errors %}<div class="invalid-feedback d-block">{{ form.conteudo.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.image.id_for_label }}" class="form-label">{{ form.image.label }}</label>
              {% render_field form.image class+="form-control" %}
              {% if form.image.help_text %}<div class="form-text">{{ form.image.help_text }}</div>{% endif %}
              {% if form.image.errors %}<div class="invalid-feedback d-block">{{ form.image.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.attachment.id_for_label }}" class="form-label">{{ form.attachment.label }}</label>
              {% render_field form.attachment class+="form-control" %}
              {% if form.attachment.help_text %}<div class="form-text">{{ form.attachment.help_text }}</div>{% endif %}
              {% if form.attachment.errors %}<div class="invalid-feedback d-block">{{ form.attachment.errors }}</div>{% endif %}
            </div>

            <div class="mt-4 d-flex gap-2">
              <button type="submit" class="btn btn-primary">{% if edit_mode %}{% trans "Save Changes" %}{% else %}{% trans "Create Post" %}{% endif %}</button>
              {% if edit_mode and post %}
                <a href="{% url 'blog:post_detail' post_id=post.id %}" class="btn btn-secondary" title="{% trans 'Cancel editing and return to post' %}">{% trans "Cancel" %}</a>
              {% else %}
                {% if turma %}
                  <a href="{% url 'class_blog:post_list' class_id=turma.id %}" class="btn btn-secondary" title="{% trans 'Cancel and return to class blog' %}">{% trans "Cancel" %}</a>
                {% else %}
                  <a href="{% url 'blog:post_list_public' %}" class="btn btn-secondary" title="{% trans 'Cancel and return' %}">{% trans "Cancel" %}</a>
                {% endif %}
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>

    <aside class="col-lg-4">
      {% if category_guidance %}
        <div class="card shadow-sm sticky-top" style="top: 90px;">
          <div class="card-header bg-primary text-white">
            <i class="bi bi-lightbulb me-2"></i>{% trans "Sugest√µes MEM" %}
          </div>
          <div class="card-body" id="guidance-panel">
            <h3 class="h5" id="guidance-title"></h3>
            <p class="text-muted" id="guidance-description"></p>
            <p class="fw-semibold mb-1">{% trans "Perguntas orientadoras:" %}</p>
            <ul class="ps-3" id="guidance-prompts"></ul>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info" role="alert">
          {% trans "MEM guidance not available." %}
        </div>
      {% endif %}
    </aside>
  </div>
</main>

{% if category_guidance %}
  {{ category_guidance|json_script:"category-guidance-data" }}
{% endif %}
{% endblock blog_content %}

{% block extra_js %}
  {{ block.super }}
  {% if category_guidance %}
    <script>
      (function() {
        const dataElement = document.getElementById('category-guidance-data');
        if (!dataElement) { return; }
        const guidance = JSON.parse(dataElement.textContent);
        const select = document.getElementById('{{ form.categoria.id_for_label }}');
        const titleEl = document.getElementById('guidance-title');
        const descriptionEl = document.getElementById('guidance-description');
        const promptsEl = document.getElementById('guidance-prompts');

        function renderGuidance(key) {
          const payload = guidance[key] || guidance['OUTRO'];
          if (titleEl) { titleEl.textContent = payload.title; }
          if (descriptionEl) { descriptionEl.textContent = payload.description; }
          if (promptsEl) {
            promptsEl.innerHTML = '';
            payload.prompts.forEach((prompt) => {
              const li = document.createElement('li');
              li.textContent = prompt;
              promptsEl.appendChild(li);
            });
          }
        }

        if (select) {
          renderGuidance(select.value || 'DIARIO');
          select.addEventListener('change', (event) => {
            renderGuidance(event.target.value);
          });
        }
      })();
    </script>
  {% endif %}
{% endblock extra_js %}
