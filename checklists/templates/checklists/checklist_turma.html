{% extends "checklists/base.html" %} {# Assuming checklists/base.html exists #}
{% load i18n checklists_extras %} {# Load i18n and custom tags #}

{% block title %}{{ template.name }} - {% trans "Class Overview" %}{% endblock %}

{% block content %}
<main role="main" aria-labelledby="class-checklist-heading">

{# Heading #}
<h2 id="class-checklist-heading">{% blocktrans with name=template.name %}Class Overview: {{ name }}{% endblocktrans %}</h2>
<h3 class="text-muted mb-3">{% blocktrans with name=turma.name year=turma.year %}Class: {{ name }} ({{ year }}){% endblocktrans %}</h3>

<!-- Overall Class Progress -->
<div class="mb-3">
  <strong>{% trans "Overall Class Progress:" %}</strong>
  {% with percentage=progresso_coletivo|floatformat:0 %}
  <div class="progress mt-1" role="progressbar" aria-label="{% trans 'Overall class progress' %}" aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100" style="height: 20px; max-width: 400px;">
    <div class="progress-bar bg-info" style="width: {{ percentage }}%;" >{{ percentage }}%</div>
  </div>
  {% endwith %}
</div>

{# Display messages #}
{% if messages %}
  <div class="messages" aria-live="polite" style="margin-bottom:1em;">
      {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans 'Close' %}"></button>
          </div>
      {% endfor %}
  </div>
{% endif %}

<!-- Checklist Table -->
<div class="table-responsive shadow-sm mt-4">
  <table class="table table-bordered table-hover table-sm align-middle" style="/* Ideally move styles to CSS */ table-layout: fixed;" aria-label="{% trans 'Class checklist progress table' %}">
    <thead class="table-light">
      <tr>
        <th scope="col" style="width: 200px; vertical-align: bottom;">{% trans "Student" %}</th>
        {# Checklist Items as Columns #}
        {% for item in items %}
          <th scope="col" class="text-center" style="width: 150px; vertical-align: bottom;" title="{{ item.description }}">
            {# Use english field name council_agreed #}
            {% if item.council_agreed %}
                <i class="bi bi-star-fill text-warning me-1" title="{% trans 'Agreed in Council' %}"></i>
            {% endif %}
            {# Use english field name description #}
            <small>{{ item.description|truncatechars:35 }}</small>
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for student_user in students %}
        <tr>
          {# Student Name and Progress Bar #}
          <td class="fw-bold">
            <div>{{ student_user.get_full_name|default:student_user.username }}</div>
            {# Access progresso_individual using get_item tag #}
            {% get_item progresso_individual student_user.id as individual_progress %}
            {% with percentage=individual_progress|default:0|floatformat:0 %}
            <div class="progress mt-1" role="progressbar" aria-label="{% trans 'Student progress' %}" aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100" style="height: 10px;">
                <div class="progress-bar bg-primary" style="width: {{ percentage }}%;"></div>
            </div>
            {% endwith %}
          </td>
          {# Status per Item #}
          {% for item in items %}
            {# Use custom tag to get the specific mark for this student/item #}
            {% get_item marks_by_student_item student_user.id item.id as mark %}
            <td class="text-center small">
              {% if mark %}
                  {# Display Status Icon based on mark_status #}
                  {% if mark.mark_status == 'completed' %}
                      {% if mark.teacher_validated %}
                          <i class="bi bi-patch-check-fill text-success fs-4" title="{% trans 'Validated by Teacher' %}"></i>
                      {% else %}
                          <i class="bi bi-check-circle-fill text-success fs-4" title="{% trans 'Completed' %}"></i>
                      {% endif %}
                  {% elif mark.mark_status == 'in_progress' %}
                      <i class="bi bi-play-circle-fill text-primary fs-4" title="{% trans 'In Progress' %}"></i>
                  {% else %}{# Assumed not_started #}
                      <i class="bi bi-square text-secondary fs-4" title="{% trans 'Not Started' %}"></i>
                  {% endif %}
                  
                  {# Display Comment if exists #}
                  {% if mark.comment %}
                      <div class="text-muted fst-italic" title="{{ mark.comment }}">{{ mark.comment|truncatechars:20 }}</div>
                  {% endif %}
                  
                  {# Teacher Actions: Validate / Rectify #}
                  <div class="mt-1">
                      {% if not mark.teacher_validated and mark.mark_status == 'completed' %}
                          {# Simple Validate Button (sets validated=True) #}
                          <form method="post" class="d-inline">
                              {% csrf_token %}
                              <input type="hidden" name="student_id" value="{{ student_user.id }}">
                              <input type="hidden" name="item_id" value="{{ item.id }}">
                              <input type="hidden" name="mark_status" value="completed"> {# Keep status #}
                              <input type="hidden" name="comment" value="{{ mark.comment|default:'' }}"> {# Keep comment #}
                              <button type="submit" class="btn btn-outline-success btn-sm py-0 px-1" title="{% trans 'Validate this completion' %}">{% trans "Validate" %}</button>
                          </form>
                      {% endif %}
                      
                      {# Rectify Button/Form (within details dropdown) #}
                      <details class="d-inline ms-1">
                          <summary class="btn btn-outline-warning btn-sm py-0 px-1" title="{% trans 'Change status or add comment' %}">{% trans "Rectify" %}</summary>
                          <form method="post" class="mt-1 p-1 border rounded bg-light d-inline-block text-start">
                              {% csrf_token %}
                              <input type="hidden" name="student_id" value="{{ student_user.id }}">
                              <input type="hidden" name="item_id" value="{{ item.id }}">
                              <select name="mark_status" class="form-select form-select-sm mb-1">
                                  {# Use choices from context #}
                                  {% for key, label in mark_status_choices %}
                                      <option value="{{ key }}" {% if mark and mark.mark_status == key %}selected{% endif %}>{{ label }}</option>
                                  {% endfor %}
                              </select>
                              <input type="text" name="comment" class="form-control form-control-sm mb-1" maxlength="150" 
                                     placeholder="{% trans 'Comment (optional)' %}" value="{{ mark.comment|default:'' }}">
                              <button type="submit" class="btn btn-warning btn-sm w-100">{% trans "Save" %}</button>
                          </form>
                      </details>
                  </div>
              {% else %}
                  {# If no mark exists, show default icon and rectify form #}
                   <i class="bi bi-square text-secondary fs-4" title="{% trans 'Not Started' %}"></i>
                   <div class="mt-1">
                       <details class="d-inline ms-1">
                          <summary class="btn btn-outline-secondary btn-sm py-0 px-1" title="{% trans 'Set initial status or comment' %}">{% trans "Set" %}</summary>
                          <form method="post" class="mt-1 p-1 border rounded bg-light d-inline-block text-start">
                              {% csrf_token %}
                              <input type="hidden" name="student_id" value="{{ student_user.id }}">
                              <input type="hidden" name="item_id" value="{{ item.id }}">
                              <select name="mark_status" class="form-select form-select-sm mb-1">
                                  {% for key, label in mark_status_choices %}
                                      <option value="{{ key }}" {% if key == 'not_started' %}selected{% endif %}>{{ label }}</option>
                                  {% endfor %}
                              </select>
                              <input type="text" name="comment" class="form-control form-control-sm mb-1" maxlength="150" 
                                     placeholder="{% trans 'Comment (optional)' %}" value="">
                              <button type="submit" class="btn btn-warning btn-sm w-100">{% trans "Save" %}</button>
                          </form>
                      </details>
                   </div>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% empty %}
        <tr><td colspan="{{ items|length|add:1 }}" class="text-center text-muted">{% trans "No students in this class." %}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Legend -->
<div class="mt-4 small text-muted d-flex flex-wrap gap-3">
  <span><i class="bi bi-square text-secondary"></i> {% trans "Not Started" %}</span>
  <span><i class="bi bi-play-circle-fill text-primary"></i> {% trans "In Progress" %}</span>
  <span><i class="bi bi-check-circle-fill text-success"></i> {% trans "Completed" %}</span>
  <span><i class="bi bi-patch-check-fill text-success"></i> {% trans "Validated by Teacher" %}</span>
  <span><i class="bi bi-star-fill text-warning"></i> {% trans "Agreed in Council" %}</span>
</div>

<!-- Back Link -->
<a href="{% url 'class_detail' class_id=turma.id %}" class="btn btn-link mt-3">&larr; {% trans "Back to Class Page" %}</a> {# Assuming class_detail is the name #}

</main>
{% endblock %}
