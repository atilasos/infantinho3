{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Assistente IA" %} - Infantinho{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chat-header {
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
    }
    
    .chat-header h2 {
        margin: 0;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .message {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        line-height: 1.5;
    }
    
    .message-user {
        align-self: flex-end;
        background: #667eea;
        color: white;
    }
    
    .message-assistant {
        align-self: flex-start;
        background: #f0f2f5;
        color: #1a1a1a;
    }
    
    .message-assistant::before {
        content: "ü§ñ ";
    }
    
    .chat-input-container {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e0e0e0;
        background: #fafafa;
        border-radius: 0 0 12px 12px;
    }
    
    .chat-form {
        display: flex;
        gap: 0.75rem;
    }
    
    .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 24px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s;
    }
    
    .chat-input:focus {
        border-color: #667eea;
    }
    
    .chat-submit {
        padding: 0.75rem 1.5rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 24px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .chat-submit:hover {
        background: #5a67d8;
    }
    
    .chat-submit:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .typing-indicator {
        display: none;
        align-self: flex-start;
        padding: 0.75rem 1rem;
        background: #f0f2f5;
        border-radius: 12px;
        color: #666;
    }
    
    .typing-indicator.active {
        display: block;
    }
    
    .typing-dots span {
        animation: blink 1.4s infinite both;
    }
    
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes blink {
        0%, 100% { opacity: 0.2; }
        50% { opacity: 1; }
    }
    
    .welcome-message {
        text-align: center;
        padding: 2rem;
        color: #666;
    }
    
    .welcome-message h3 {
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .pedagogical-note {
        font-size: 0.85rem;
        color: #888;
        text-align: center;
        padding: 0.5rem;
        background: #fffbeb;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h2>
            üéì {% trans "Assistente Pedag√≥gico" %}
            {% if class_instance %} - {{ class_instance.name }}{% endif %}
        </h2>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        {% if not messages %}
        <div class="welcome-message">
            <h3>üëã {% trans "Ol√°!" %}</h3>
            {% if user_role == 'aluno' %}
            <p>{% trans "Sou o teu assistente de aprendizagem. Estou aqui para te ajudar a pensar e descobrir, n√£o para te dar respostas!" %}</p>
            <p>{% trans "O que est√°s a estudar hoje?" %}</p>
            {% else %}
            <p>{% trans "Sou o assistente pedag√≥gico para professores. Posso ajudar-te com an√°lise de dados dos alunos, planeamento e feedback." %}</p>
            <p>{% trans "Em que posso ajudar?" %}</p>
            {% endif %}
        </div>
        <div class="pedagogical-note">
            üí° {% trans "Lembra-te: sigo a pedagogia MEM. Fa√ßo perguntas para te ajudar a descobrir as respostas por ti pr√≥prio/a!" %}
        </div>
        {% endif %}
        
        {% for msg in messages %}
        <div class="message message-{{ msg.role }}">
            {{ msg.content|linebreaks }}
        </div>
        {% endfor %}
        
        <div class="typing-indicator" id="typingIndicator">
            ü§ñ <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
    </div>
    
    <div class="chat-input-container">
        <form class="chat-form" id="chatForm">
            <input type="hidden" id="conversationId" value="{{ conversation.id }}">
            <input 
                type="text" 
                class="chat-input" 
                id="messageInput" 
                placeholder="{% trans 'Escreve a tua mensagem...' %}"
                autocomplete="off"
                required
            >
            <button type="submit" class="chat-submit" id="sendButton">
                {% trans "Enviar" %}
            </button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('chatForm');
    const input = document.getElementById('messageInput');
    const messages = document.getElementById('chatMessages');
    const typing = document.getElementById('typingIndicator');
    const sendButton = document.getElementById('sendButton');
    const conversationId = document.getElementById('conversationId').value;
    
    function scrollToBottom() {
        messages.scrollTop = messages.scrollHeight;
    }
    
    function addMessage(role, content) {
        const div = document.createElement('div');
        div.className = 'message message-' + role;
        div.innerHTML = content.replace(/\n/g, '<br>');
        messages.insertBefore(div, typing);
        scrollToBottom();
    }
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = input.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage('user', message);
        input.value = '';
        
        // Show typing indicator
        typing.classList.add('active');
        sendButton.disabled = true;
        scrollToBottom();
        
        try {
            const response = await fetch('{% url "ai_assistant:send_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: conversationId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addMessage('assistant', data.message.content);
            } else {
                addMessage('assistant', '‚ùå ' + (data.error || 'Erro ao processar a mensagem.'));
            }
        } catch (error) {
            addMessage('assistant', '‚ùå Erro de liga√ß√£o. Tenta novamente.');
        } finally {
            typing.classList.remove('active');
            sendButton.disabled = false;
            input.focus();
        }
    });
    
    // Focus input on load
    input.focus();
    scrollToBottom();
});
</script>
{% endblock %}
