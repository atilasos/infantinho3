{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="container mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">{% trans "PITs da Turma" %} — {{ turma.name }}</h1>
    <div>
      <a href="{% url 'classes:class_detail' class_id=turma.id %}" class="btn btn-sm btn-secondary"><i class="bi bi-arrow-left"></i> {% trans "Voltar à turma" %}</a>
    </div>
  </div>

  <form method="get" class="mb-3 p-3 bg-light border rounded">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label" for="status">{% trans "Estado" %}</label>
        <select class="form-select form-select-sm" id="status" name="status">
          <option value="">{% trans "Todos" %}</option>
          <option value="draft" {% if status == 'draft' %}selected{% endif %}>{% trans "Rascunho" %}</option>
          <option value="submitted" {% if status == 'submitted' %}selected{% endif %}>{% trans "Submetido" %}</option>
          <option value="approved" {% if status == 'approved' %}selected{% endif %}>{% trans "Aprovado" %}</option>
          <option value="concluded" {% if status == 'concluded' %}selected{% endif %}>{% trans "Concluído" %}</option>
          <option value="evaluated" {% if status == 'evaluated' %}selected{% endif %}>{% trans "Avaliado" %}</option>
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label" for="q">{% trans "Pesquisa" %}</label>
        <input type="text" class="form-control form-control-sm" id="q" name="q" value="{{ q|default:'' }}" placeholder="{% trans 'Aluno ou período…' %}">
      </div>
      <div class="col-md-auto">
        <button class="btn btn-sm btn-primary" type="submit">{% trans "Filtrar" %}</button>
        {% if status or q %}
          <a class="btn btn-sm btn-outline-secondary ms-1" href="?">{% trans "Limpar" %}</a>
        {% endif %}
      </div>
    </div>
  </form>

  <table class="table table-sm align-middle">
    <thead>
      <tr>
        <th>{% trans "Aluno" %}</th>
        <th>{% trans "Período" %}</th>
        <th>{% trans "Estado" %}</th>
        <th>{% trans "Ações" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for plan in plans %}
      <tr>
        <td>{{ plan.student.get_full_name|default:plan.student.username }}</td>
        <td>{{ plan.period_label }}</td>
        <td>
          <span class="badge {% if plan.status == 'submitted' %}text-bg-warning text-dark{% elif plan.status == 'approved' %}text-bg-primary{% elif plan.status == 'concluded' %}text-bg-secondary{% elif plan.status == 'evaluated' %}text-bg-success{% else %}text-bg-light text-dark{% endif %}">{{ plan.get_status_display }}</span>
        </td>
        <td>
          <form method="post" action="{% url 'pit:teacher_plan_approve' class_id=turma.id plan_id=plan.id %}">
            {% csrf_token %}
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-success" name="action" value="approve" {% if plan.status != 'submitted' %}disabled{% endif %}>{% trans "Aprovar" %}</button>
              <button class="btn btn-outline-secondary" name="action" value="return" {% if plan.status != 'submitted' %}disabled{% endif %}>{% trans "Devolver" %}</button>
            </div>
          </form>
           {% if plan.status == 'approved' or plan.teacher_evaluation %}
          <div class="mt-1">
            <form method="post" action="{% url 'pit:teacher_plan_approve' class_id=turma.id plan_id=plan.id %}">
              {% csrf_token %}
              <textarea class="form-control form-control-sm" name="teacher_evaluation" rows="2" placeholder="{% trans 'Avaliação do professor' %}">{{ plan.teacher_evaluation }}</textarea>
              <div class="text-end mt-1">
                <button class="btn btn-sm btn-primary" name="action" value="evaluate">{% trans "Guardar avaliação" %}</button>
              </div>
            </form>
          </div>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="4" class="text-muted">{% trans "Sem PITs registados." %}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% if plans.has_other_pages %}
    <nav aria-label="{% trans 'Paginação' %}">
      <ul class="pagination justify-content-center">
        <li class="page-item {% if not plans.has_previous %}disabled{% endif %}">
          <a class="page-link" href="?page=1{% if status %}&status={{ status }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">&laquo;</a>
        </li>
        <li class="page-item {% if not plans.has_previous %}disabled{% endif %}">
          <a class="page-link" href="{% if plans.has_previous %}?page={{ plans.previous_page_number }}{% if status %}&status={{ status }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}{% endif %}">&lsaquo;</a>
        </li>
        <li class="page-item disabled"><span class="page-link">{{ plans.number }}/{{ plans.paginator.num_pages }}</span></li>
        <li class="page-item {% if not plans.has_next %}disabled{% endif %}">
          <a class="page-link" href="{% if plans.has_next %}?page={{ plans.next_page_number }}{% if status %}&status={{ status }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}{% endif %}">&rsaquo;</a>
        </li>
        <li class="page-item {% if not plans.has_next %}disabled{% endif %}">
          <a class="page-link" href="?page={{ plans.paginator.num_pages }}{% if status %}&status={{ status }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">&raquo;</a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <a href="{% url 'classes:class_detail' class_id=turma.id %}" class="btn btn-secondary btn-sm">{% trans "Voltar à turma" %}</a>
</div>
{% endblock %}


