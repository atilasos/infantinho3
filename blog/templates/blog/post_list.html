{% extends 'blog/base.html' %}
{% load i18n %}
{% load tz %}{# Required for timezone conversions if needed #}
{% load auth_extras %}

{% block blog_title %}{% trans "Blog/Diary" %} - {{ turma.name }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'landing_page' %}">{% trans "Blog" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'classes:class_list' %}">{% trans "Classes" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'classes:class_detail' class_id=turma.id %}">{{ turma.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Class Blog" %}</li>
  </ol>
 </nav>
{% endblock %}

{# Override the main content block from the parent base template #}
{% block blog_content %}

<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
  {# Use class name from context #}
  <h1 class="h2">{% trans "Blog/Diary" %} - {{ turma.name }}</h1>
  <div>
    <a href="{% url 'classes:class_detail' class_id=turma.id %}" class="btn btn-outline-secondary btn-sm me-2"><i class="bi bi-arrow-left"></i> {% trans "Voltar Ã  turma" %}</a>
    {# Button to create a new post #}
    {% load auth_extras %}
    {% if request.user.is_superuser or request.user.role == 'admin' or request.user|has_group:'professor' or request.user|has_group:'aluno' %}
      <div class="mt-3">
          <a href="{% url 'class_blog:post_create' class_id=turma.id %}" class="btn btn-success">
              <i class="bi bi-plus-circle"></i> {% trans "Create New Post" %}
          </a>
      </div>
    {% endif %}
    {# Link to help page #}
        <a href="{% url 'class_blog:blog_help' class_id=turma.id %}" class="btn btn-outline-info btn-sm" title="{% trans 'Help for Blog/Diary' %}">
      <i class="bi bi-question-circle"></i> {% trans "Help" %}
    </a>
  </div>
</div>

<!-- Filter Form -->
<form method="get" class="mb-4 p-3 bg-light border rounded" aria-label="{% trans 'Blog Filters' %}">
  <div class="row g-3 align-items-end">
    <div class="col-md-4">
      <label for="categoria" class="form-label">{% trans "Category:" %}</label>
      <select name="categoria" id="categoria" class="form-select form-select-sm" title="{% trans 'Filter by category' %}">
        <option value="">{% trans "All" %}</option>
        {# Use choices passed from view context #}
        {% for key, label in categorias %}
          <option value="{{ key }}" {% if key == categoria_atual %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label for="data" class="form-label">{% trans "Date:" %}</label>
      {# Use date input type #}
      <input type="date" name="data" id="data" value="{{ data_atual|default:'' }}" class="form-control form-control-sm" title="{% trans 'Filter by date' %}">
    </div>
    <div class="col-md-auto">
      <button type="submit" class="btn btn-primary btn-sm" title="{% trans 'Apply Filters' %}">{% trans "Filter" %}</button>
      {# Add a clear button if filters are active #}
      {% if categoria_atual or data_atual %}
        <a href="{% url 'class_blog:post_list' class_id=turma.id %}" class="btn btn-outline-secondary btn-sm ms-2">{% trans "Clear" %}</a>
      {% endif %}
    </div>
  </div>
</form>

{# Post List as Card Grid grouped visually by month headings #}
{% if posts_grouped %}
  {% for key, posts_mes in posts_grouped.items %}
    {% with year=key.0 month=key.1 %}
      <h4 class="mt-4 text-muted">{{ month }}/{{ year }}</h4>
      <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for post in posts_mes %}
          <div class="col">
            <div class="card h-100 shadow-sm">
              {% if post.image %}
                <a href="/blog/post/{{ post.id }}/">
                  <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.titulo|default:post.get_categoria_display }}" style="max-height: 220px; object-fit: cover;">
                </a>
              {% endif %}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-2">
                  <a href="/blog/post/{{ post.id }}/" class="stretched-link text-decoration-none text-dark">
                    {{ post.titulo|default:post.get_categoria_display }}
                  </a>
                  {% if request.user.is_authenticated %}
                    {% if request.user.is_superuser or request.user.role == 'admin' or request.user|has_group:'professor' %}
                      {% if post.status == 'PENDING' %}
                        <span class="badge bg-warning text-dark ms-2 align-middle">{% trans "Pending" %}</span>
                      {% elif post.removido %}
                        <span class="badge bg-secondary ms-2 align-middle">{% trans "Removed" %}</span>
                      {% endif %}
                    {% endif %}
                  {% endif %}
                </h5>
                <p class="card-subtitle mb-2 text-muted small">
                  <i class="bi bi-person me-1"></i> {{ post.autor.get_full_name|default:post.autor.username }}
                  <span class="mx-1">|</span>
                  <i class="bi bi-calendar3 me-1"></i> {{ post.publicado_em|localtime|date:"SHORT_DATETIME_FORMAT" }}
                  {% if post.categoria %}
                    <span class="mx-1">|</span>
                    <span class="badge bg-secondary"><i class="bi bi-tag me-1"></i> {{ post.get_categoria_display }}</span>
                  {% endif %}
                </p>
                <div class="card-text text-secondary mb-1">
                  {{ post.conteudo|striptags|truncatewords_html:30|safe }}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endwith %}
  {% endfor %}
{% elif categoria_atual or data_atual %}
   {# Message when filters applied but no results #}
   <div class="alert alert-info" role="alert">
     {% trans "No posts found matching your filters." %}
   </div>
{% else %}
  {# Message when no posts exist at all #}
  <div class="alert alert-secondary" role="alert">
    {% trans "No posts have been created in this blog yet." %}
  </div>
{% endif %}

<!-- Pagination Controls -->
{% if posts.has_other_pages %}
  <nav aria-label="{% trans 'Post navigation' %}">
    <ul class="pagination justify-content-center">
      {# First page link #}
      <li class="page-item {% if not posts.has_previous %}disabled{% endif %}">
          <a class="page-link" href="?page=1{% if categoria_atual %}&categoria={{ categoria_atual }}{% endif %}{% if data_atual %}&data={{ data_atual }}{% endif %}" aria-label="{% trans 'First' %}">&laquo;</a>
      </li>
      {# Previous page link #}
      <li class="page-item {% if not posts.has_previous %}disabled{% endif %}">
          <a class="page-link" href="{% if posts.has_previous %}?page={{ posts.previous_page_number }}{% if categoria_atual %}&categoria={{ categoria_atual }}{% endif %}{% if data_atual %}&data={{ data_atual }}{% endif %}{% else %}"#"{% endif %}" aria-label="{% trans 'Previous' %}">{% trans "Previous" %}</a>
      </li>
      
      {# Page numbers #}
      {% for i in posts.paginator.page_range %}
          {% if posts.number == i %}
              <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
          {% elif i > posts.number|add:'-3' and i < posts.number|add:'3' %}
              <li class="page-item"><a class="page-link" href="?page={{ i }}{% if categoria_atual %}&categoria={{ categoria_atual }}{% endif %}{% if data_atual %}&data={{ data_atual }}{% endif %}">{{ i }}</a></li>
          {% elif i == posts.number|add:'-3' or i == posts.number|add:'3' %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
      {% endfor %}
      
      {# Next page link #}
      <li class="page-item {% if not posts.has_next %}disabled{% endif %}">
          <a class="page-link" href="{% if posts.has_next %}?page={{ posts.next_page_number }}{% if categoria_atual %}&categoria={{ categoria_atual }}{% endif %}{% if data_atual %}&data={{ data_atual }}{% endif %}{% else %}"#"{% endif %}" aria-label="{% trans 'Next' %}">{% trans "Next" %}</a>
      </li>
      {# Last page link #}
       <li class="page-item {% if not posts.has_next %}disabled{% endif %}">
          <a class="page-link" href="?page={{ posts.paginator.num_pages }}{% if categoria_atual %}&categoria={{ categoria_atual }}{% endif %}{% if data_atual %}&data={{ data_atual }}{% endif %}" aria-label="{% trans 'Last' %}">&raquo;</a>
        </li>
    </ul>
  </nav>
{% endif %}

{% endblock blog_content %}
