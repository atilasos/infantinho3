{% extends "blog/base.html" %}
{% load i18n tz %}

{% block blog_title %}{{ post.titulo|default:post.get_category_display_full }} - {{ turma.name }}{% endblock %}

{% block blog_content %}

{# Display messages from views if any #}
{% if messages %}
  <div class="messages" aria-live="polite" style="margin-bottom:1em;">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans 'Close' %}"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Main Article Section -->
<article aria-labelledby="post-heading">

  <!-- Display if Post is Removed -->
  {% if post.removido %}
    <div class="alert alert-warning shadow-sm mb-3" role="alert">
      <h4 class="alert-heading">{% trans "Post Removed" %}</h4>
      <p>{% trans "This post was removed by moderation." %}</p>
      <hr>
      {% if post.motivo_remocao %}
        <p class="mb-1"><strong>{% trans "Reason:" %}</strong> {{ post.motivo_remocao }}</p>
      {% endif %}
      {% if post.removido_por %}
        <p class="mb-0"><small>{% trans "Removed by:" %} {{ post.removido_por.get_full_name|default:post.removido_por.username }} | {{ post.removido_em|timezone:request.user.timezone|date:"SHORT_DATETIME_FORMAT" }}</small></p>
      {% endif %}
    </div>

    <!-- Restore Option for Moderators -->
    {% if request.user.is_authenticated %}
      {# Check if user is admin or teacher of this specific class #}
      {% if user.is_superuser or (user.role == 'professor' and turma in user.classes_taught.all()) %}
        <div class="card mb-3 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">{% trans "Moderation Action" %}</h5>
            <p class="card-text">{% trans "As a moderator for this class, you can restore this post." %}</p>
            <form method="post" action="{% url 'blog:post_restore' class_id=turma.id post_id=post.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm" title="{% trans 'Restore this post' %}">
                <i class="bi bi-arrow-counterclockwise"></i> {% trans "Restore Post" %}
              </button>
            </form>
            {# Link to moderation logs #}
            <a href="{% url 'blog:moderation_logs' class_id=turma.id %}" class="btn btn-outline-secondary btn-sm ms-2" title="{% trans 'View moderation history for this class' %}">
              <i class="bi bi-journal-text"></i> {% trans "View Moderation Log" %}
            </a>
          </div>
        </div>
      {% endif %}
    {% endif %}
    {# Back button for removed post state #}
    <a href="{% url 'blog:post_list' class_id=turma.id %}" class="btn btn-secondary mt-2" title="{% trans 'Return to post list' %}">&larr; {% trans "Back to Blog" %}</a>
  
  <!-- Display Post Content if Not Removed -->
  {% else %}
    <header class="mb-3 pb-2 border-bottom">
      <h1 class="h2" id="post-heading">{{ post.titulo|default:post.get_category_display_full }}</h1>
      <p class="text-muted small">
          {% blocktrans with author=post.autor.get_full_name|default:post.autor.username date=post.publicado_em|timezone:request.user.timezone|date:"SHORT_DATETIME_FORMAT" category=post.get_category_display_full %}
            By {{ author }} | Published: {{ date }} | Category: {{ category }}
          {% endblocktrans %}
      </p>
    </header>
    
    <!-- Post Content -->
    <div class="post-content mb-4">
      {{ post.conteudo|safe }}
    </div>

    <!-- Post Action Buttons (Edit/Remove) -->
    <div class="post-actions mb-4 border-top pt-3">
        {% if can_edit_post %}
          <a href="{% url 'blog:post_edit' class_id=turma.id post_id=post.id %}" class="btn btn-warning btn-sm me-2" title="{% trans 'Edit this post' %}">
            <i class="bi bi-pencil-square"></i> {% trans "Edit" %}
          </a>
        {% endif %}
        {% if can_remove_post %}
          <button type="button" class="btn btn-danger btn-sm" 
             data-bs-toggle="modal" data-bs-target="#removePostModal-{{ post.id }}" 
             title="{% trans 'Remove this post' %}">
            <i class="bi bi-trash"></i> {% trans "Remove" %}
          </button>
        {% endif %}
        {# Add back button here as well #}
         <a href="{% url 'blog:post_list' class_id=turma.id %}" class="btn btn-outline-secondary btn-sm ms-2" title="{% trans 'Return to post list' %}">&larr; {% trans "Back to Blog List" %}</a>
    </div>
 
    <hr>

    <!-- Comments Section -->
    <section id="comments" aria-labelledby="comments-heading">
      <h3 id="comments-heading" class="h4">{% trans "Comments" %} <span class="badge bg-secondary rounded-pill">{{ comentarios.count }}</span></h3>
      
      <!-- List Existing Comments -->
      <div class="comments-list mb-4">
        {% if comentarios %}
          {% for comentario in comentarios %}
            <div class="card mb-2 shadow-sm" id="comment-{{ comentario.id }}">
              <div class="card-body p-3">
                <p class="card-text">{{ comentario.conteudo|linebreaksbr }}</p>
                <footer class="blockquote-footer mb-0 d-flex justify-content-between align-items-center">
                  <div>
                    {{ comentario.autor.get_full_name|default:comentario.autor.username }} 
                    <cite title="{% trans 'Publication date' %}"><small> - {{ comentario.publicado_em|timezone:request.user.timezone|date:"SHORT_DATETIME_FORMAT" }}</small></cite>
                  </div>
                  {# Comment Remove Button (for Moderators) #}
                  {% if comentario.is_removable_by(request.user) %}
                    <form method="post" action="{% url 'blog:comment_remove' class_id=turma.id post_id=post.id comment_id=comentario.id %}" 
                          class="d-inline" 
                          onsubmit="return confirm('{% trans "Are you sure you want to remove this comment?" %}');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger btn-sm py-0 px-1" title="{% trans 'Remove this comment' %}">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  {% endif %}
                </footer>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p>{% trans "No comments yet." %}</p>
        {% endif %}
      </div>

      <!-- Add Comment Form -->
      {% if request.user.is_authenticated %}
        <div class="add-comment-form mt-4 pt-3 border-top">
          <h5>{% trans "Add your comment" %}</h5>
          <form method="post" action="{% url 'blog:post_comment' class_id=turma.id post_id=post.id %}" class="mb-3" aria-label="{% trans 'Comment form' %}">
            {% csrf_token %}
            {# Render form fields using Bootstrap structure #}
            <div class="mb-3">
                {{ comment_form.conteudo }} {# Assumes widget attrs set placeholder/rows in forms.py #}
                {% if comment_form.conteudo.errors %}
                    <div class="invalid-feedback d-block">{{ comment_form.conteudo.errors|striptags }}</div>
                {% endif %}
            </div>
            <button type="submit" class="btn btn-primary btn-sm" title="{% trans 'Publish comment' %}">{% trans "Post Comment" %}</button>
          </form>
        </div>
      {% else %}
        <p class="mt-4 pt-3 border-top"><em><a href="{% url 'users:login_choice' %}?next={{ request.path }}">{% trans "Log in" %}</a> {% trans "to add a comment." %}</em></p>
      {% endif %}
    </section>

  {% endif %} {# End else block for non-removed post #}

</article>

<!-- Modal for Remove Post Confirmation -->
{% if not post.removido and can_remove_post %}
<div class="modal fade" id="removePostModal-{{ post.id }}" tabindex="-1" aria-labelledby="removePostModalLabel-{{ post.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'blog:post_remove' class_id=turma.id post_id=post.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="removePostModalLabel-{{ post.id }}">{% trans "Confirm Removal" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
        </div>
        <div class="modal-body">
          <p>{% blocktrans with title=post.titulo|default:post.get_category_display_full %}Are you sure you want to remove the post "{{ title }}"?{% endblocktrans %}</p>
          <div class="mb-3">
            <label for="motivo-{{ post.id }}" class="form-label">{% trans "Reason (optional):" %}</label>
            <input type="text" class="form-control form-control-sm" name="motivo" id="motivo-{{ post.id }}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="submit" class="btn btn-danger">{% trans "Confirm Removal" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% endblock blog_content %}
