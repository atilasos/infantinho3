{% extends "base.html" %}
{% load i18n widget_tweaks %}

{% block title %}
  {% if edit_mode %}
    {% blocktrans with title=post.titulo|default:_('Post') %}Edit Post: {{ title }}{% endblocktrans %}
  {% else %}
    {% trans "Create New Post" %}
  {% endif %}
  | {{ block.super }}
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row g-4 align-items-start justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h1 class="h4 mb-3">{% if edit_mode %}{% trans "Edit Post" %}{% else %}{% trans "Create New Post" %}{% endif %}</h1>
          <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger" role="alert">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <div class="mb-3">
              <label for="{{ form.turma.id_for_label }}" class="form-label">{{ form.turma.label }}</label>
              {% render_field form.turma class+="form-select" %}
              {% if form.turma.help_text %}<div class="form-text">{{ form.turma.help_text }}</div>{% endif %}
              {% if form.turma.errors %}<div class="invalid-feedback d-block">{{ form.turma.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.titulo.id_for_label }}" class="form-label">{{ form.titulo.label }}</label>
              {% render_field form.titulo class+="form-control" %}
              {% if form.titulo.help_text %}<div class="form-text">{{ form.titulo.help_text }}</div>{% endif %}
              {% if form.titulo.errors %}<div class="invalid-feedback d-block">{{ form.titulo.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.categoria.id_for_label }}" class="form-label">{{ form.categoria.label }}</label>
              {% render_field form.categoria class+="form-select" %}
              {% if form.categoria.help_text %}<div class="form-text">{{ form.categoria.help_text }}</div>{% endif %}
              {% if form.categoria.errors %}<div class="invalid-feedback d-block">{{ form.categoria.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.conteudo.id_for_label }}" class="form-label">{{ form.conteudo.label }}</label>
              {% render_field form.conteudo %}
              {% if form.conteudo.errors %}<div class="invalid-feedback d-block">{{ form.conteudo.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.image.id_for_label }}" class="form-label">{{ form.image.label }}</label>
              {% render_field form.image class+="form-control" %}
              {% if form.image.help_text %}<div class="form-text">{{ form.image.help_text }}</div>{% endif %}
              {% if form.image.errors %}<div class="invalid-feedback d-block">{{ form.image.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.attachment.id_for_label }}" class="form-label">{{ form.attachment.label }}</label>
              {% render_field form.attachment class+="form-control" %}
              {% if form.attachment.help_text %}<div class="form-text">{{ form.attachment.help_text }}</div>{% endif %}
              {% if form.attachment.errors %}<div class="invalid-feedback d-block">{{ form.attachment.errors|striptags }}</div>{% endif %}
            </div>

            <hr>

            <button type="submit" class="btn btn-success">
              {% if edit_mode %}<i class="bi bi-save me-1"></i> {% trans "Save Changes" %}{% else %}<i class="bi bi-send me-1"></i> {% trans "Submit Post" %}{% endif %}
            </button>
            <a href="{% if edit_mode %}{% url 'blog:post_detail' post_id=post.id %}{% else %}{% url 'landing_page' %}{% endif %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
          </form>
        </div>
      </div>
    </div>

    <aside class="col-lg-4">
      {% if category_guidance %}
        <div class="card shadow-sm sticky-top" style="top: 90px;">
          <div class="card-header bg-primary text-white">
            <i class="bi bi-lightbulb me-2"></i>{% trans "Sugest√µes MEM" %}
          </div>
          <div class="card-body">
            <h2 class="h5" id="guidance-title"></h2>
            <p class="text-muted" id="guidance-description"></p>
            <p class="fw-semibold mb-1">{% trans "Perguntas orientadoras:" %}</p>
            <ul class="ps-3" id="guidance-prompts"></ul>
          </div>
        </div>
      {% endif %}
    </aside>
  </div>
</div>

{% if category_guidance %}
  {{ category_guidance|json_script:"category-guidance-data" }}
{% endif %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  {% if category_guidance %}
    <script>
      (function() {
        const dataElement = document.getElementById('category-guidance-data');
        if (!dataElement) { return; }
        const guidance = JSON.parse(dataElement.textContent);
        const select = document.getElementById('{{ form.categoria.id_for_label }}');
        const titleEl = document.getElementById('guidance-title');
        const descriptionEl = document.getElementById('guidance-description');
        const promptsEl = document.getElementById('guidance-prompts');

        function renderGuidance(key) {
          const payload = guidance[key] || guidance['OUTRO'];
          if (titleEl) { titleEl.textContent = payload.title; }
          if (descriptionEl) { descriptionEl.textContent = payload.description; }
          if (promptsEl) {
            promptsEl.innerHTML = '';
            payload.prompts.forEach((prompt) => {
              const li = document.createElement('li');
              li.textContent = prompt;
              promptsEl.appendChild(li);
            });
          }
        }

        if (select) {
          renderGuidance(select.value || 'DIARIO');
          select.addEventListener('change', (event) => {
            renderGuidance(event.target.value);
          });
        }
      })();
    </script>
  {% endif %}
{% endblock %}
